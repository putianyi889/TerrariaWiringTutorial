\chapter{从零开始}

\section{前言}\label{sec1:1}
\begin{note}
本书初编写时的游戏是1.3.5.3版本。1.4更新后我们正在努力学习新的内容并更新。
\end{note}

本书定位为“文档”，主要用于系统性收录电路理论，因此行文中会先讲理论后讲例子。如果读者觉得理论难以理解，不妨先看例子，再结合例子看理论。

每章后的思考题，有部分是经典电路的分析理解，有部分是因为我懒而没有去做的电路，还有一部分是纯理论推导。它们的共同点就是做不做都无所谓。与思考题相比，正文中用于举例、自成一节的电路是必须熟练掌握的。

学习\nameref{dianlujichu}后，你就可以做出大多数解谜地图与刷怪场里的电路，包括南瓜神教等。学习\nameref{sec7}后，你将可以研究设计复杂电路，例如电路小游戏。\nameref{chap7}难度较高，仅供有能力的读者阅读。不要忽视附录，附录中包含大量的有价值链接与游戏机制，它们会有助于你学习电路和设计一些场地。

因为泰拉瑞亚官方资料都是全英文的，并且几乎所有英文资料都没有翻译，所以在对泰拉瑞亚进行深入研究的时候请务必备好词典以及初中以上的英文水准。同时，一定的计算机或数学专业知识也会有帮助。如果你在词典的帮助下仍然看不懂英文，建议找人求助，而不是去使用机翻，机翻基本上没有一句话是准确的。

如果你对于纯文字的内容难以接受，也可以去观看视频教程，链接在附录中。视频相对于文字的缺点主要是时效性，因为视频不易更改，所以视频中的技术往往是已被淘汰的技术。我们仍建议在理解了视频教程的内容后以本书作为主参考。

本书中所有游戏名词首选为\href{https://store.steampowered.com/}{Steam平台}上最新版本\href{https://store.steampowered.com/app/105600/Terraria/}{泰拉瑞亚}的中文，其次是\href{https://terraria-zh.gamepedia.com/index.php?title=Terraria_Wiki&variant=zh}{中文wiki}。此外，对于想做大型装置的同学，\hyperref[app3]{地图编辑器}与模组\footnote{\hyperref[app4]{tModLoader}、\hyperref[app5]{CheatSheet}、\hyperref[app6]{HERO's mod}}是必不可少的，它们可以帮助你快速建造、备份。

关于游戏机制，如果你有编程基础，看反编译的\hyperref[app8]{c\#源码}是最可靠的方法。否则请参考\hyperref[app2]{Wiki}，对Wiki有疑问的话再求助可以看懂源码的人。附录中的游戏机制均通过源码得到。

本书正文部分用于集中讨论电路，对于电路以外的信息会在附录中讨论。

在\github{putianyi889/TerrariaWiringTutorial}协助编写本书是唯一的支持我们的方式。你可以主动创作，也可以在\href{https://github.com/putianyi889/TerrariaWiringTutorial/issues}{Issues}中领取任务。如果你不会使用GitHub，可以看教程\url{https://zhuanlan.zhihu.com/p/34693871}。关注 (Watch) 本书的GitHub项目可以即时获取更新信息。

\section{一些基本概念与机制}

\subsection{实体}
实体指的是可以发生碰撞的物体\footnote{严格地讲，实体是编程术语，这里仅仅是在不影响游戏理解的前提下进行简化。}，包括但不限于\wikii{NPC_ID}{NPC}、\wiki{人物}、\wiki{射弹}、\wiki{物品}、\wikii{图格_ID}{图格}。

史莱姆对玩家造成接触伤害，就是史莱姆（NPC）与玩家的碰撞；玩家用弓射出木箭击中了史莱姆，就是史莱姆（NPC）与木箭（射弹）的碰撞；玩家被血肉墙激光击中，就是玩家与激光（射弹）的碰撞；玩家、掉落物、大多数NPC、大多数射弹不能穿墙，是因为玩家、掉落物、NPC、射弹会和图格碰撞。

碰撞是通过碰撞箱判定的，例如史莱姆与玩家碰撞，是因为史莱姆的碰撞箱与玩家的碰撞箱有重叠。泰拉瑞亚中所有实体的碰撞箱均为矩形，有宽度和高度两个属性，它们可以在\nameref{app8}中查到。

\subsection{硬上限与软上限}
泰拉瑞亚中许多实体都有数量上限，而数量上限又分为硬上限和软上限。硬上限是游戏中的静态常量，例如NPC硬上限200等。软上限是游戏中的变量，例如活跃刷怪数量（一般在5到15）等。

从程序角度来说，硬上限是由C\#定长数组的长度决定的，如果尝试突破会导致数组越界。为避免在正常游戏过程中出现崩溃现象，游戏程序中在关键函数中都有越界检查，例如NPC达到上限时，游戏会拒绝生成新NPC以防止崩溃。软上限是开发者对游戏的平衡控制，例如玩家附近的活跃敌怪数量到达15则不会进行刷怪。

目前已知的硬上限见\autoref{tab8928}。
\begin{longtable}{|c|c|}
\caption{泰拉瑞亚中的硬上限}\label{tab8928}\\\hline
对象&上限\\\hline
\endfirsthead
\hline 对象&上限\\\hline
\endhead
\hline
\endfoot
buff&22\\\hline
傀儡影子&100\\\hline
NPC&200\\\hline
玩家&255\\\hline
掉落物&400\\\hline
射弹&1000\\\hline
冷却机关&1000\\\hline
宝箱&1000\\\hline
活跃液体&5000\\\hline
缓冲液体&10000
\end{longtable}

\subsection{图像帧/物理帧}

图像帧(frame)指泰拉瑞亚游戏过程中电脑显示屏更新的每帧画面，在游戏中按F10可以在游戏窗口左下角显示当前图像帧率。

物理帧(tick)指泰拉瑞亚中时间的最小单位，为1/60秒。在物理帧的尺度下，泰拉瑞亚是回合制游戏，每个物理帧中，除电路外所有的游戏机制会依一定顺序结算。由于本书是针对游戏机制的讨论，未经特殊说明的情况下将直接用“帧”表示物理帧。

游戏运行时，显卡负责图像处理，CPU负责机制结算。如果这两个过程都能在1/60秒内完成，那么物理帧率就是60。如果CPU处理时间大于1/60秒，那么相应的物理帧率会变低。如果显卡处理时间大于1/60秒，那么结果取决于是否跳帧。如果设置中打开跳帧，那么会适当降低图像帧率以保持CPU能达到的最高物理帧率。如果关闭跳帧，那么图像帧和物理帧会完全同步，实时的游戏速度以显卡和CPU中的最慢速度为准。

\subsection{坐标}\label{tab8}
坐标就是在世界中的位置。坐标并非深度计与罗盘所显示的那样。程序中的坐标是以世界左上角为(0,0)，横坐标向右，纵坐标向下。世界宽度为 \lstinline{maxTilesX} 格，高度为 \lstinline{maxTilesY} 格。世界右下角的坐标为(\lstinline{maxTilesX}, \lstinline{maxTilesY})。

泰拉瑞亚中纵坐标分层一般分为太空、地表、地下、洞穴、地狱五层。而游戏机制中，只有两个阈值，一个是地表层与地下层交界处的纵坐标，称为\lstinline{worldSurface}；另一个是地下层与洞穴层交界处的纵坐标，称为\lstinline{rockLayer}。太空层高度是把\lstinline{rockLayer}乘上一个系数得到的；地狱层高度是把\lstinline{maxTilesY}减去一个常数得到的。这个系数一般是0.35，常数一般是200格，但是在不同情况下也可能会有出入。

\subsection{度量}
泰拉瑞亚中的长度单位有：英里、格、英尺、像素。换算关系是1英尺=8像素=1/2格=1/5280英里。

泰拉瑞亚中的时间单位有：帧、秒、分、天。换算关系是1天=24分，1分=60秒，1秒=60帧。有的时候帧、秒、分也分别叫做游戏秒、游戏分、游戏时。

速度单位=长度单位/时间单位，主要有：英里/小时、格/秒、像素/帧。

程序内部的长度单位是像素，时间单位是帧，速度单位是像素/帧。

\subsection{驱动}

驱动(engine)指可以间歇性自动激活电路的装置。驱动按频率分类可分为低频驱动、高频驱动、满频驱动、超频驱动。

\begin{itemize}
\item 低频驱动指频率小于等于4Hz的驱动。这类驱动一般通过计时器降频得到。
\item 高频驱动指频率大于4Hz且小于60Hz的驱动。这类驱动造法非常丰富，最可靠稳定的方法是利用满频驱动降频。
\item 满频驱动指频率等于60Hz的驱动。主流的满频驱动有假人驱动和传送带驱动。之所以叫满频驱动，是因为驱动频率与物理帧率相同。更高的频率也可以通过满频驱动得到相同的效果。例如，120Hz的驱动的输出效果和两个满频驱动同时输出的效果完全相同。
\item 超频驱动指频率大于60Hz的驱动。此类驱动一般用多个满频驱动同时运行，或者利用测重压力板的超灵敏度。目前还没有超频驱动的应用实例。
\end{itemize}

\subsection{半砖}

当掉落物/非穿墙生物的碰撞箱与实体块重合时，程序会尝试将碰撞箱推离实体块。从1.2版本开始，大多数前景物块都有六种半砖形态，每种半砖推离碰撞箱的机制各不相同。尽管半砖在电路中占有一席之地，由于其：本身不涉及到电路；应用不广泛\footnote{其大多数功能可以用传送机或传送带解决。}；目前没有严谨的机制；设计装置主要靠经验和尝试，本书中暂时不涉及半砖教学。

关于半砖有关的研究与教程，读者可以参考附录。

\subsection{射弹生成以及刷新机制}
射弹(projectile)是泰拉瑞亚中的一大类实体。包括但不限于机关射出来的飞镖、火焰，抛出的悠悠球，棱镜射出的激光，扔出的沙滩球，挥舞的日耀链刃，甚至玩家死亡后弹跳的墓碑。

这小节内容主要针对所有射弹的生成及刷新过程，用于后续某些内容的引用，读者大可直接跳过本小节。

游戏使用一个长度为1000的列表存储射弹。射弹生成时，其信息会被存储在射弹列表的第一个空位。如果射弹列表没有空位，那么该射弹不会生成。

每个物理帧，游戏会执行一轮射弹刷新过程，即对列表从头到尾扫描，对每个射弹执行其刷新函数。每个射弹的刷新方式取决于射弹的id。射弹刷新第一步是改变射弹的位置，即$$\textrm{新位置}=\textrm{原位置}+\textrm{速度。}$$对于非匀速直线运动的射弹，还需要对其速度进行计算。第二步就要进行碰撞判定，射弹如果与生物碰撞了，就可能要进行伤害计算；如果与前景物块碰撞了，就可能要销毁射弹；如果与青绿压力垫板碰撞了，就可能要插入电路结算。这最后一种情况就是这本书主要关心的内容。

机关射弹的刷新机制列举在附录中。